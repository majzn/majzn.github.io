<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCraft Designer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['Menlo', 'Monaco', 'Courier New', 'monospace'],
                    },
                    colors: {
                        gray: {
                            850: '#1f2937',
                            950: '#030712',
                        }
                    },
                    fontSize: {
                        xxs: '0.65rem',
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Grid background patterns */
        .bg-grid-light { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .bg-grid-dark { background-image: radial-gradient(#374151 1px, transparent 1px); background-size: 20px 20px; }

        /* Accordion Animation */
        .accordion-content { transition: grid-template-rows 0.2s ease-out; }
        .accordion-arrow { transition: transform 0.2s; }
        .group.open .accordion-arrow { transform: rotate(90deg); }
        
        /* Compact UI tweaks */
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 2px; }
    </style>
</head>
<body class="h-screen flex flex-col font-sans overflow-hidden bg-gray-50 text-gray-900 transition-colors duration-200 selection:bg-blue-100 selection:text-blue-900 dark:selection:bg-blue-900 dark:selection:text-white dark">

    <!-- Input for file upload (hidden) -->
    <input type="file" id="file-input" accept=".html,.htm" class="hidden" />

    <!-- Header -->
    <header class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 h-10 flex items-center justify-between px-2 shrink-0 z-20 select-none transition-colors">
        <div class="flex items-center gap-2">
            <div class="flex items-center gap-1.5 text-blue-600 dark:text-blue-500 font-bold text-sm tracking-tight pl-1">
                <i data-lucide="layout" class="w-4 h-4"></i>
                <span>WebCraft</span>
            </div>
            <div class="h-3 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
            
            <!-- Viewport Controls -->
            <div class="flex bg-gray-100 dark:bg-gray-800 rounded p-0.5 gap-0.5" id="viewport-controls">
                <button data-view="desktop" class="p-1 rounded-sm transition-all text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300" title="Desktop">
                    <i data-lucide="monitor" class="w-3 h-3"></i>
                </button>
                <button data-view="tablet" class="p-1 rounded-sm transition-all text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300" title="Tablet">
                    <i data-lucide="tablet" class="w-3 h-3"></i>
                </button>
                <button data-view="mobile" class="p-1 rounded-sm transition-all text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300" title="Mobile">
                    <i data-lucide="smartphone" class="w-3 h-3"></i>
                </button>
            </div>

            <div class="h-3 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
            
            <!-- History Controls -->
            <div class="flex items-center gap-0.5">
                <button id="btn-undo" class="p-1 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded disabled:opacity-30 disabled:cursor-not-allowed transition-colors" title="Undo (Ctrl+Z)">
                    <i data-lucide="undo" class="w-3.5 h-3.5"></i>
                </button>
                <button id="btn-redo" class="p-1 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded disabled:opacity-30 disabled:cursor-not-allowed transition-colors" title="Redo (Ctrl+Y)">
                    <i data-lucide="redo" class="w-3.5 h-3.5"></i>
                </button>
            </div>
        </div>
        
        <!-- Right Actions -->
        <div class="flex items-center gap-1.5">
            <button id="btn-theme" class="p-1 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors" title="Toggle Theme">
                <i data-lucide="moon" class="w-3.5 h-3.5" id="theme-icon"></i>
            </button>
            <div class="h-3 w-px bg-gray-200 dark:bg-gray-700 mx-0.5"></div>
            <button id="btn-open" class="flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded transition-colors">
                <i data-lucide="file-up" class="w-3 h-3"></i> Open
            </button>
            <button id="btn-export" class="flex items-center gap-1 px-2.5 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold rounded shadow-sm transition-colors">
                <i data-lucide="download" class="w-3 h-3"></i> Export
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar Navigation -->
        <div class="w-10 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col items-center py-2 gap-2 shrink-0 z-10 transition-colors">
            <button id="mode-visual" class="p-2 rounded transition-all bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400" title="Visual Editor">
                <i data-lucide="mouse-pointer-2" class="w-4 h-4"></i>
            </button>
            <button id="mode-code" class="p-2 rounded transition-all text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-600" title="Code Editor">
                <i data-lucide="code" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex bg-gray-100 dark:bg-gray-950 relative overflow-hidden transition-colors" id="main-area">
            
            <!-- Code Editor Mode -->
            <div id="code-container" class="absolute inset-0 z-20 hidden">
                <textarea id="code-editor" class="w-full h-full bg-gray-900 text-gray-100 font-mono text-xs p-4 resize-none focus:outline-none leading-relaxed" spellcheck="false"></textarea>
            </div>

            <!-- Visual Mode -->
            <div id="visual-container" class="flex-1 flex items-center justify-center p-6 overflow-auto w-full h-full bg-grid-light dark:bg-grid-dark transition-all">
                <div id="preview-wrapper" class="w-full h-full bg-white transition-all duration-300 border border-gray-200 dark:border-gray-800 shadow-xl overflow-hidden relative">
                    <!-- Iframe will be injected here -->
                </div>
            </div>
        </div>

        <!-- Inspector Panel -->
        <div id="inspector-panel" class="w-72 bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 flex flex-col shrink-0 h-full shadow-xl z-10 transition-colors">
            
            <!-- Inspector Header -->
            <div class="px-2 py-1.5 border-b border-gray-200 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-900/50 backdrop-blur-sm">
                <h2 class="font-bold text-xxs uppercase tracking-wider text-gray-500 dark:text-gray-400 flex items-center gap-1.5 mb-1">
                    <i data-lucide="sliders" class="w-3 h-3"></i> Properties
                </h2>
                <div id="selected-element-info" class="text-xs text-gray-400 italic py-0.5">Select an element to edit</div>
            </div>

            <!-- Inspector Content -->
            <div id="inspector-content" class="flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-200 dark:scrollbar-thumb-gray-800">
                <div class="flex flex-col items-center justify-center h-48 text-gray-400 dark:text-gray-600 gap-2">
                    <i data-lucide="mouse-pointer-2" class="w-8 h-8 opacity-50"></i>
                    <p class="text-xs">No element selected</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- Constants & Config ---
        const DEFAULT_CODE = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Designed Page</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 2rem; background: #f9fafb; color: #1f2937; transition: all 0.2s; }
        .card { background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); max-width: 24rem; margin: 0 auto; }
        h1 { color: #2563eb; margin-bottom: 1rem; font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
        p { line-height: 1.6; color: #4b5563; margin-bottom: 1.5rem; }
        button { background: #2563eb; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; transition: background 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:hover { background: #1d4ed8; transform: translateY(-1px); }
    </style>
</head>
<body>
    <div class="card">
        <h1>Welcome Builder</h1>
        <p>Select any element on this page to edit its styles, text content, or attributes using the panel on the right.</p>
        <button id="action-btn" data-type="primary">Click Me</button>
    </div>
</body>
</html>`;

        const INJECTED_SCRIPT_ID = "webcraft-injector";
        const INJECTED_SCRIPT = `
<script id="${INJECTED_SCRIPT_ID}">
    (function() {
        let selectedEl = null;
        
        function triggerResize() {
            window.dispatchEvent(new Event('resize'));
        }
        
        window.addEventListener('DOMContentLoaded', triggerResize);
        window.addEventListener('load', function() {
            setTimeout(triggerResize, 50);
            setTimeout(triggerResize, 500); 
        });

        function getSelector(el) {
            if (!el) return '';
            if (el.tagName.toLowerCase() === 'html') return 'html';
            let str = el.tagName.toLowerCase();
            str += (el.id) ? '#' + el.id : '';
            if (el.className && typeof el.className === 'string') {
                const classes = el.className.split(/\\s+/).filter(c => c !== '__selected_outline__');
                if (classes.length) str += '.' + classes.join('.');
            }
            return str;
        }

        function getComputedStyles(el) {
            if (!el) return {};
            const s = window.getComputedStyle(el);
            return {
                color: s.color, backgroundColor: s.backgroundColor, fontSize: s.fontSize,
                fontWeight: s.fontWeight, textAlign: s.textAlign, lineHeight: s.lineHeight,
                letterSpacing: s.letterSpacing, padding: s.padding, margin: s.margin,
                borderWidth: s.borderWidth, borderColor: s.borderColor, borderRadius: s.borderRadius,
                borderStyle: s.borderStyle, display: s.display, position: s.position,
                flexDirection: s.flexDirection, justifyContent: s.justifyContent, alignItems: s.alignItems,
                flexWrap: s.flexWrap, width: s.width, height: s.height, opacity: s.opacity,
                zIndex: s.zIndex, boxShadow: s.boxShadow, overflow: s.overflow, cursor: s.cursor
            };
        }

        function getAttributes(el) {
            if (!el) return {};
            const attrs = {};
            if (el.hasAttributes()) {
                for (let i = 0; i < el.attributes.length; i++) {
                    const attr = el.attributes[i];
                    if (attr.name !== 'style' && attr.name !== 'data-gramm') attrs[attr.name] = attr.value;
                }
            }
            return attrs;
        }

        function notifySelection() {
            if (!selectedEl) return;
            const path = [];
            let curr = selectedEl;
            while(curr && curr.tagName) {
                path.unshift(getSelector(curr));
                curr = curr.parentElement;
            }
            window.parent.postMessage({
                type: 'elementSelected',
                tagName: selectedEl.tagName.toLowerCase(),
                path: path,
                styles: getComputedStyles(selectedEl),
                content: selectedEl.innerText,
                attributes: getAttributes(selectedEl)
            }, '*');
        }

        function cleanAndNotify() {
             if(selectedEl) {
                const currentOutline = selectedEl.style.outline;
                const currentOffset = selectedEl.style.outlineOffset;
                selectedEl.style.outline = '';
                selectedEl.style.outlineOffset = '';
                
                const htmlContent = document.documentElement.outerHTML;
                
                selectedEl.style.outline = currentOutline;
                selectedEl.style.outlineOffset = currentOffset;
                
                window.parent.postMessage({ type: 'contentUpdated', html: '<!DOCTYPE html>' + htmlContent }, '*');
             }
        }

        window.addEventListener('click', function(e) {
            e.preventDefault(); e.stopPropagation();
            if(selectedEl) { selectedEl.style.outline = ''; selectedEl.style.outlineOffset = ''; }
            selectedEl = e.target;
            selectedEl.style.outline = '2px solid #3b82f6';
            selectedEl.style.outlineOffset = '-2px';
            notifySelection();
        }, true);

        window.addEventListener('message', function(e) {
            if (!selectedEl) return;
            if (e.data.type === 'updateStyle') {
                selectedEl.style[e.data.property] = e.data.value;
                cleanAndNotify();
            } else if (e.data.type === 'updateContent') {
                selectedEl.innerText = e.data.value;
                cleanAndNotify();
            } else if (e.data.type === 'updateAttribute') {
                if (e.data.value === null) selectedEl.removeAttribute(e.data.attribute);
                else selectedEl.setAttribute(e.data.attribute, e.data.value);
                cleanAndNotify();
            }
        });
    })();
<\/script>`;

        // --- State Management ---
        const state = {
            code: DEFAULT_CODE,
            mode: 'visual',
            viewport: 'desktop',
            darkMode: true, // Default to Dark Mode
            history: [DEFAULT_CODE],
            historyIndex: 0,
            selectedElement: null
        };

        // --- DOM Elements ---
        const els = {
            body: document.body,
            codeEditor: document.getElementById('code-editor'),
            previewWrapper: document.getElementById('preview-wrapper'),
            visualContainer: document.getElementById('visual-container'),
            codeContainer: document.getElementById('code-container'),
            inspectorPanel: document.getElementById('inspector-panel'),
            inspectorContent: document.getElementById('inspector-content'),
            selectedInfo: document.getElementById('selected-element-info'),
            modeBtns: {
                visual: document.getElementById('mode-visual'),
                code: document.getElementById('mode-code')
            },
            viewportBtns: document.querySelectorAll('#viewport-controls button'),
            fileInput: document.getElementById('file-input')
        };
        
        let previewFrame = null;

        // --- Core Functions ---
        function init() {
            lucide.createIcons();
            rebuildIframe(state.code);
            render();
            attachListeners();
        }

        function setState(newState) {
            const oldMode = state.mode;
            Object.assign(state, newState);
            render();
            if (newState.mode === 'visual' && oldMode === 'code') {
                rebuildIframe(state.code);
            }
        }

        function updateHistory(newCode) {
            if (state.history[state.historyIndex] === newCode) return;
            
            const newHistory = state.history.slice(0, state.historyIndex + 1);
            newHistory.push(newCode);
            if (newHistory.length > 50) newHistory.shift();
            
            state.history = newHistory;
            state.historyIndex = newHistory.length - 1;
            state.code = newCode;
            
            updateUI();
        }

        function updateUI() {
            document.getElementById('btn-undo').disabled = state.historyIndex <= 0;
            document.getElementById('btn-redo').disabled = state.historyIndex >= state.history.length - 1;
        }

        function render() {
            if (state.darkMode) els.body.classList.add('dark');
            else els.body.classList.remove('dark');
            document.getElementById('theme-icon').setAttribute('data-lucide', state.darkMode ? 'sun' : 'moon');

            const widthMap = { mobile: '375px', tablet: '768px', desktop: '100%' };
            els.previewWrapper.style.width = widthMap[state.viewport];
            
            els.viewportBtns.forEach(btn => {
                const isActive = btn.dataset.view === state.viewport;
                const activeClass = state.darkMode ? 'bg-gray-600' : 'bg-white';
                const shadowClass = 'shadow-sm';
                const textActive = state.darkMode ? 'text-blue-400' : 'text-blue-600';
                
                if (isActive) {
                    btn.classList.add(activeClass, shadowClass, textActive);
                    btn.classList.remove('text-gray-400', 'hover:text-gray-600');
                } else {
                    btn.classList.remove(activeClass, shadowClass, textActive);
                    btn.classList.add('text-gray-400');
                }
            });

            if (state.mode === 'code') {
                els.codeContainer.classList.remove('hidden');
                els.inspectorPanel.classList.add('hidden');
                
                if (els.codeEditor.value !== state.code) {
                    els.codeEditor.value = state.code;
                }
                
                els.modeBtns.code.className = `p-2 rounded transition-all ${state.darkMode ? 'bg-blue-900/30 text-blue-400' : 'bg-blue-50 text-blue-600'}`;
                els.modeBtns.visual.className = 'p-2 rounded transition-all text-gray-400 hover:text-gray-600';
            } else {
                els.codeContainer.classList.add('hidden');
                els.inspectorPanel.classList.remove('hidden');
                
                els.modeBtns.visual.className = `p-2 rounded transition-all ${state.darkMode ? 'bg-blue-900/30 text-blue-400' : 'bg-blue-50 text-blue-600'}`;
                els.modeBtns.code.className = 'p-2 rounded transition-all text-gray-400 hover:text-gray-600';
            }

            renderInspector();
            updateUI();
            lucide.createIcons();
        }

        function rebuildIframe(codeToRender) {
            const oldFrame = document.querySelector('#preview-wrapper iframe');
            if (oldFrame) oldFrame.remove();

            const iframe = document.createElement('iframe');
            iframe.className = "w-full h-full block bg-white";
            iframe.sandbox = "allow-scripts allow-same-origin allow-modals";
            iframe.title = "preview";
            
            els.previewWrapper.appendChild(iframe);
            previewFrame = iframe; 

            const doc = iframe.contentDocument;
            doc.open();
            let finalCode = codeToRender;
            if (finalCode.includes('</body>')) {
                finalCode = finalCode.replace('</body>', INJECTED_SCRIPT + '</body>');
            } else {
                finalCode += INJECTED_SCRIPT;
            }
            doc.write(finalCode);
            doc.close();
        }

        // --- Inspector Logic ---
        function renderInspector() {
            if (!state.selectedElement) {
                els.selectedInfo.textContent = 'Select an element to edit';
                els.inspectorContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-48 text-gray-400 dark:text-gray-600 gap-2">
                        <i data-lucide="mouse-pointer-2" class="w-8 h-8 opacity-50"></i>
                        <p class="text-xs">No element selected</p>
                    </div>`;
                return;
            }

            const el = state.selectedElement;
            els.selectedInfo.innerHTML = `
                <div class="text-[10px] font-mono text-blue-600 dark:text-blue-400 break-all bg-blue-50 dark:bg-blue-900/20 px-1.5 py-1 rounded border border-blue-100 dark:border-blue-900/30">
                    <span class="font-bold">${el.tagName}</span>
                    ${el.attributes.id ? `<span class="text-orange-600 dark:text-orange-400">#${el.attributes.id}</span>` : ''}
                    ${el.attributes.class ? `<span class="text-purple-600 dark:text-purple-400">.${el.attributes.class.split(' ').join('.')}</span>` : ''}
                </div>`;

            let html = '';
            
            const createAccordion = (title, icon, content) => `
                <div class="group open border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-800">
                    <button onclick="this.parentElement.classList.toggle('open')" class="w-full flex items-center justify-between px-2 py-2 text-[10px] font-bold uppercase tracking-wider text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors select-none">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="${icon}" class="text-blue-500 w-3 h-3"></i> ${title}
                        </div>
                        <i data-lucide="chevron-right" class="w-3 h-3 accordion-arrow"></i>
                    </button>
                    <div class="accordion-content hidden group-[.open]:block px-2 py-2 bg-gray-50/80 dark:bg-black/20">
                        ${content}
                    </div>
                </div>`;

            const attributesContent = `
                <div class="space-y-2">
                    ${createInput('Text Content', el.content, 'content', 'innerText', null, 'w-full')}
                    <div class="space-y-1.5">
                        <div class="flex items-center justify-between">
                            <label class="text-[9px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Attributes</label>
                            <button onclick="addAttribute()" class="p-0.5 hover:bg-blue-50 dark:hover:bg-blue-900/30 text-blue-600 rounded transition-colors" title="Add Attribute"><i data-lucide="plus" class="w-3 h-3"></i></button>
                        </div>
                        ${Object.entries(el.attributes).map(([k, v]) => `
                            <div class="flex items-center gap-1.5 group/attr">
                                <div class="w-1/3 text-[10px] font-mono text-gray-600 dark:text-gray-400 truncate" title="${k}">${k}</div>
                                <input value="${v}" onchange="updateProperty('attribute', '${k}', this.value)" class="flex-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded px-1.5 py-0.5 text-[11px] text-gray-900 dark:text-gray-100 focus:outline-none focus:border-blue-500 h-6" />
                                <button onclick="updateProperty('attribute', '${k}', null)" class="p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover/attr:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-2.5 h-2.5"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            html += createAccordion('Parameters', 'tag', attributesContent);

            const layoutContent = `
                <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                    ${createInput('Display', el.styles.display, 'style', 'display', ['block', 'inline-block', 'flex', 'inline-flex', 'grid', 'none'])}
                    ${createInput('Position', el.styles.position, 'style', 'position', ['static', 'relative', 'absolute', 'fixed', 'sticky'])}
                </div>
                <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                    ${createInput('Width', el.styles.width, 'style', 'width')}
                    ${createInput('Height', el.styles.height, 'style', 'height')}
                </div>
                <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                    ${createInput('Padding', el.styles.padding, 'style', 'padding')}
                    ${createInput('Margin', el.styles.margin, 'style', 'margin')}
                </div>
                <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                    ${createInput('Z-Index', el.styles.zIndex, 'style', 'zIndex')}
                    ${createInput('Overflow', el.styles.overflow, 'style', 'overflow', ['visible', 'hidden', 'scroll', 'auto'])}
                </div>
                ${el.styles.display && el.styles.display.includes('flex') ? `
                    <div class="mt-1.5 p-1.5 bg-gray-100 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                        <div class="text-[9px] font-bold text-gray-500 mb-1.5 uppercase">Flexbox</div>
                        <div class="grid grid-cols-2 gap-1.5">
                            ${createInput('Dir', el.styles.flexDirection, 'style', 'flexDirection', ['row', 'column', 'row-reverse', 'column-reverse'])}
                            ${createInput('Wrap', el.styles.flexWrap, 'style', 'flexWrap', ['nowrap', 'wrap', 'wrap-reverse'])}
                            ${createInput('Justify', el.styles.justifyContent, 'style', 'justifyContent', ['flex-start', 'center', 'flex-end', 'space-between', 'space-around'])}
                            ${createInput('Align', el.styles.alignItems, 'style', 'alignItems', ['stretch', 'flex-start', 'center', 'flex-end', 'baseline'])}
                        </div>
                    </div>` : ''}
            `;
            html += createAccordion('Layout', 'box', layoutContent);

            const typoContent = `
                <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                    ${createInput('Size', el.styles.fontSize, 'style', 'fontSize')}
                    ${createInput('Color', rgbToHex(el.styles.color), 'style', 'color', null, '', 'color')}
                </div>
                <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                    ${createInput('Weight', el.styles.fontWeight, 'style', 'fontWeight', ['100','200','300','400','500','600','700','800','900', 'bold', 'normal'])}
                    ${createInput('Align', el.styles.textAlign, 'style', 'textAlign', ['left', 'center', 'right', 'justify'])}
                </div>
                <div class="grid grid-cols-2 gap-1.5">
                    ${createInput('Line H', el.styles.lineHeight, 'style', 'lineHeight')}
                    ${createInput('Spacing', el.styles.letterSpacing, 'style', 'letterSpacing')}
                </div>
            `;
            html += createAccordion('Typography', 'type', typoContent);

            const appearContent = `
                <div class="space-y-1.5">
                    ${createInput('Background', rgbToHex(el.styles.backgroundColor), 'style', 'backgroundColor', null, '', 'color')}
                    <div class="grid grid-cols-2 gap-1.5">
                        ${createInput('Opacity', el.styles.opacity, 'style', 'opacity')}
                        ${createInput('Cursor', el.styles.cursor, 'style', 'cursor', ['auto', 'pointer', 'text', 'move', 'not-allowed'])}
                    </div>
                    ${createInput('Shadow', el.styles.boxShadow, 'style', 'boxShadow')}
                </div>
            `;
            html += createAccordion('Appearance', 'palette', appearContent);

            const borderContent = `
                <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                    ${createInput('Radius', el.styles.borderRadius, 'style', 'borderRadius')}
                    ${createInput('Width', el.styles.borderWidth, 'style', 'borderWidth')}
                </div>
                <div class="grid grid-cols-2 gap-1.5">
                    ${createInput('Style', el.styles.borderStyle, 'style', 'borderStyle', ['none', 'solid', 'dashed', 'dotted', 'double'])}
                    ${createInput('Color', rgbToHex(el.styles.borderColor), 'style', 'borderColor', null, '', 'color')}
                </div>
            `;
            html += createAccordion('Borders', 'layers', borderContent);

            els.inspectorContent.innerHTML = html;
        }

        function createInput(label, value, type, prop, options = null, className = "", inputType = "text") {
            const safeVal = value === undefined || value === null ? '' : value.toString().replace(/"/g, '&quot;');
            let inputHtml;
            
            if (options) {
                inputHtml = `
                    <div class="relative">
                        <select onchange="updateProperty('${type}', '${prop}', this.value)" 
                            class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded px-1.5 py-0.5 text-[11px] text-gray-900 dark:text-gray-100 focus:outline-none focus:border-blue-500 h-6 appearance-none cursor-pointer">
                            ${options.map(o => `<option value="${o}" ${o === value ? 'selected' : ''}>${o}</option>`).join('')}
                        </select>
                        <div class="absolute right-2 top-1.5 pointer-events-none text-gray-500">
                             <svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                    </div>`;
            } else {
                inputHtml = `
                    <div class="relative flex items-center w-full">
                        <input type="${inputType}" value="${safeVal}" onchange="updateProperty('${type}', '${prop}', this.value)" 
                            class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded px-1.5 py-0.5 text-[11px] text-gray-900 dark:text-gray-100 focus:outline-none focus:border-blue-500 h-6 ${inputType === 'color' ? 'pl-7' : ''}" 
                            placeholder="${inputType === 'text' ? 'Auto' : ''}" />
                        ${inputType === 'color' ? `<div class="absolute left-1 top-1 bottom-1 w-5 rounded-sm border border-gray-200 dark:border-gray-600 pointer-events-none" style="background-color: ${safeVal}"></div>` : ''}
                    </div>`;
            }

            return `
                <div class="flex flex-col ${className}">
                    ${label ? `<label class="text-[9px] font-bold text-gray-500 dark:text-gray-400 mb-0.5 uppercase tracking-wider truncate" title="${label}">${label}</label>` : ''}
                    ${inputHtml}
                </div>`;
        }

        window.updateProperty = (type, property, value) => {
            if (!state.selectedElement || !previewFrame) return;

            const el = state.selectedElement;
            if (type === 'style') el.styles[property] = value;
            else if (type === 'content') el.content = value;
            else if (type === 'attribute') {
                if (value === null) delete el.attributes[property];
                else el.attributes[property] = value;
            }

            previewFrame.contentWindow.postMessage({
                type: type === 'style' ? 'updateStyle' : type === 'content' ? 'updateContent' : 'updateAttribute',
                property: property,
                attribute: property,
                value: value
            }, '*');
        };

        window.addAttribute = () => {
            const name = prompt("Enter attribute name (e.g., 'src', 'data-id'):");
            if (name) updateProperty('attribute', name, "");
        };

        function attachListeners() {
            els.viewportBtns.forEach(btn => {
                btn.addEventListener('click', () => setState({ viewport: btn.dataset.view }));
            });

            document.getElementById('btn-theme').addEventListener('click', () => setState({ darkMode: !state.darkMode }));
            els.modeBtns.visual.addEventListener('click', () => setState({ mode: 'visual' }));
            els.modeBtns.code.addEventListener('click', () => setState({ mode: 'code' }));

            document.getElementById('btn-undo').addEventListener('click', () => {
                if (state.historyIndex > 0) {
                    const prevCode = state.history[state.historyIndex - 1];
                    state.historyIndex--;
                    state.code = prevCode;
                    state.selectedElement = null; 
                    rebuildIframe(prevCode);
                    render();
                }
            });
            document.getElementById('btn-redo').addEventListener('click', () => {
                if (state.historyIndex < state.history.length - 1) {
                    const nextCode = state.history[state.historyIndex + 1];
                    state.historyIndex++;
                    state.code = nextCode;
                    state.selectedElement = null;
                    rebuildIframe(nextCode);
                    render();
                }
            });

            document.getElementById('btn-open').addEventListener('click', () => els.fileInput.click());
            els.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(file) loadFile(file);
                els.fileInput.value = '';
            });
            
            document.getElementById('btn-export').addEventListener('click', () => {
                const blob = new Blob([state.code], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'design.html';
                a.click();
                URL.revokeObjectURL(url);
            });
            
            els.codeEditor.addEventListener('input', (e) => {
                state.code = e.target.value;
            });
            els.codeEditor.addEventListener('blur', () => {
                updateHistory(state.code);
            });

            document.body.addEventListener('dragover', e => e.preventDefault());
            document.body.addEventListener('drop', e => {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if (file) loadFile(file);
            });

            window.addEventListener('message', (e) => {
                if (e.data.type === 'elementSelected') {
                    setState({ selectedElement: e.data });
                    if(state.mode !== 'visual') setState({ mode: 'visual' });
                } else if (e.data.type === 'contentUpdated') {
                    let cleanHtml = e.data.html;
                    const idRegex = new RegExp(`<script id="${INJECTED_SCRIPT_ID}">[\\s\\S]*?<\\/script>`, 'g');
                    if (idRegex.test(cleanHtml)) {
                        cleanHtml = cleanHtml.replace(idRegex, '');
                    } else {
                         cleanHtml = cleanHtml.replace(/<script>[\s\S]*?getComputedStyles[\s\S]*?<\/script>/g, '');
                    }
                    updateHistory(cleanHtml);
                }
            });
            
            window.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
                    e.preventDefault();
                    if (e.shiftKey) document.getElementById('btn-redo').click();
                    else document.getElementById('btn-undo').click();
                } else if ((e.metaKey || e.ctrlKey) && e.key === 'y') {
                    e.preventDefault();
                    document.getElementById('btn-redo').click();
                }
            });
        }

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.code = e.target.result;
                state.history = [e.target.result];
                state.historyIndex = 0;
                state.selectedElement = null;
                state.mode = 'visual';
                rebuildIframe(state.code);
                render();
            };
            reader.readAsText(file);
        }

        function rgbToHex(rgb) {
            if (!rgb || rgb === 'transparent' || rgb === 'rgba(0, 0, 0, 0)') return '#ffffff';
            if (rgb.startsWith('#')) return rgb;
            try {
                const sep = rgb.indexOf(",") > -1 ? "," : " ";
                const rgbArr = rgb.substr(4).split(")")[0].split(sep);
                let r = (+rgbArr[0]).toString(16), g = (+rgbArr[1]).toString(16), b = (+rgbArr[2]).toString(16);
                if (r.length === 1) r = "0" + r;
                if (g.length === 1) g = "0" + g;
                if (b.length === 1) b = "0" + b;
                return "#" + r + g + b;
            } catch (e) { return '#000000'; }
        }

        init();
    </script>
</body>
</html>